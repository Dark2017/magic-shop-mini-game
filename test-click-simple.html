<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>H5ç‚¹å‡»äº‹ä»¶æµ‹è¯• - ç®€åŒ–ç‰ˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #2C1810;
            color: white;
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 2px solid #FFD700;
            background: #87CEEB;
            display: block;
            margin: 20px auto;
        }
        .log {
            background: rgba(0,0,0,0.8);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        .button {
            background: #FFD700;
            color: #2C1810;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª H5ç‚¹å‡»äº‹ä»¶æµ‹è¯•</h1>
    <p>æµ‹è¯•AdManagerç¯å¢ƒæ£€æµ‹å’Œç‚¹å‡»äº‹ä»¶å¤„ç†</p>
    
    <canvas id="testCanvas" width="414" height="600"></canvas>
    
    <div>
        <button class="button" onclick="testEnvironmentDetection()">æµ‹è¯•ç¯å¢ƒæ£€æµ‹</button>
        <button class="button" onclick="testAdManager()">æµ‹è¯•å¹¿å‘Šç®¡ç†å™¨</button>
        <button class="button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="log" id="logArea"></div>

    <script>
        // æ—¥å¿—åŠŸèƒ½
        function log(message) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `<div>[${time}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }

        // æ¨¡æ‹Ÿwx API
        function createMockWx() {
            window.wx = {
                createRewardedVideoAd: function(options) {
                    // æ ‡è®°ä¸ºH5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿï¼Œç”¨äºç¯å¢ƒæ£€æµ‹
                    const ad = {
                        load: () => {
                            log('H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ - åŠ è½½æ¿€åŠ±è§†é¢‘å¹¿å‘Š');
                            return Promise.resolve();
                        },
                        show: () => {
                            log('H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ - æ˜¾ç¤ºæ¿€åŠ±è§†é¢‘å¹¿å‘Š');
                            return Promise.resolve();
                        },
                        onLoad: (callback) => setTimeout(callback, 100),
                        onError: (callback) => {},
                        onClose: (callback) => {
                            setTimeout(() => {
                                callback({ isEnded: true });
                            }, 1000);
                        }
                    };
                    
                    // é‡è¦ï¼šæ·»åŠ H5æ¨¡æ‹Ÿæ ‡è¯†
                    ad.toString = () => 'function() { /* H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ */ }';
                    
                    return ad;
                },
                showModal: function(options) {
                    const result = confirm((options.title || '') + '\n\n' + (options.content || ''));
                    if (options.success) {
                        options.success({ confirm: result, cancel: !result });
                    }
                },
                showToast: function(options) {
                    log('Toast: ' + options.title);
                },
                getStorageSync: function(key) {
                    try {
                        const data = localStorage.getItem('test_' + key);
                        return data ? JSON.parse(data) : null;
                    } catch (e) {
                        return null;
                    }
                },
                setStorageSync: function(key, data) {
                    try {
                        localStorage.setItem('test_' + key, JSON.stringify(data));
                    } catch (e) {
                        log('å­˜å‚¨å¤±è´¥: ' + e.message);
                    }
                }
            };
            log('âœ… æ¨¡æ‹Ÿwxå¯¹è±¡å·²åˆ›å»º');
        }

        // ç®€åŒ–çš„AdManagerç”¨äºæµ‹è¯•
        class TestAdManager {
            constructor() {
                this.isH5Environment = null;
                log('ğŸ”„ AdManageræ„é€ å‡½æ•°å¼€å§‹');
                
                // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿wxå¯¹è±¡å·²ç»åˆ›å»º
                setTimeout(() => {
                    this.isH5Environment = this.detectH5Environment();
                    this.init();
                }, 100);
            }
            
            detectH5Environment() {
                log('ğŸ” å¼€å§‹ç¯å¢ƒæ£€æµ‹...');
                
                if (typeof window === 'undefined') {
                    log('âŒ éæµè§ˆå™¨ç¯å¢ƒ');
                    return false;
                }
                
                if (!window.wx) {
                    log('âŒ æ²¡æœ‰wxå¯¹è±¡ï¼Œåˆ¤æ–­ä¸ºH5ç¯å¢ƒ');
                    return true;
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ¨¡æ‹Ÿçš„wxå¯¹è±¡
                const isSimulatedWx = window.wx.createRewardedVideoAd && 
                                     window.wx.createRewardedVideoAd.toString().includes('H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ');
                
                log(`ğŸ” wxå¯¹è±¡å­˜åœ¨: true`);
                log(`ğŸ” createRewardedVideoAdå­˜åœ¨: ${!!window.wx.createRewardedVideoAd}`);
                log(`ğŸ” æ˜¯å¦ä¸ºæ¨¡æ‹Ÿwx: ${isSimulatedWx}`);
                
                return isSimulatedWx || !window.wx.createRewardedVideoAd;
            }
            
            init() {
                log(`ğŸ¯ ç¯å¢ƒæ£€æµ‹ç»“æœ: ${this.isH5Environment ? 'H5ç¯å¢ƒ' : 'å¾®ä¿¡ç¯å¢ƒ'}`);
                
                if (this.isH5Environment) {
                    log('âœ… H5ç¯å¢ƒ - ä½¿ç”¨æ¨¡æ‹Ÿå¹¿å‘Šç³»ç»Ÿ');
                } else {
                    log('âœ… å¾®ä¿¡ç¯å¢ƒ - ä½¿ç”¨åŸç”Ÿå¹¿å‘Šç³»ç»Ÿ');
                }
            }
            
            showReviveAd(callback) {
                log('ğŸ“º å°è¯•æ˜¾ç¤ºå¤æ´»å¹¿å‘Š');
                
                if (this.isH5Environment === null) {
                    log('â³ ç¯å¢ƒæ£€æµ‹ä¸­ï¼Œå»¶è¿Ÿæ‰§è¡Œå¹¿å‘Šæ˜¾ç¤º');
                    setTimeout(() => this.showReviveAd(callback), 200);
                    return;
                }
                
                if (this.isH5Environment) {
                    log('ğŸ® H5ç¯å¢ƒ - æ¨¡æ‹Ÿå¹¿å‘Šæ’­æ”¾');
                    setTimeout(() => {
                        log('âœ… å¹¿å‘Šè§‚çœ‹å®Œæˆï¼Œæ‰§è¡Œå›è°ƒ');
                        callback(true);
                    }, 1000);
                } else {
                    log('ğŸ“± å¾®ä¿¡ç¯å¢ƒ - æ˜¾ç¤ºåŸç”Ÿå¹¿å‘Š');
                    // å¾®ä¿¡ç¯å¢ƒé€»è¾‘
                }
            }
        }

        // æµ‹è¯•åŠŸèƒ½
        function testEnvironmentDetection() {
            log('=== å¼€å§‹ç¯å¢ƒæ£€æµ‹æµ‹è¯• ===');
            clearLog();
            
            // å…ˆåˆ›å»ºwxå¯¹è±¡
            createMockWx();
            
            // å†åˆ›å»ºAdManager
            setTimeout(() => {
                window.testAdManager = new TestAdManager();
            }, 50);
        }

        function testAdManager() {
            if (!window.testAdManager) {
                log('âŒ è¯·å…ˆè¿è¡Œç¯å¢ƒæ£€æµ‹æµ‹è¯•');
                return;
            }
            
            log('=== å¼€å§‹å¹¿å‘Šç®¡ç†å™¨æµ‹è¯• ===');
            
            window.testAdManager.showReviveAd((success) => {
                if (success) {
                    log('ğŸ‰ å¤æ´»å¹¿å‘Šæµ‹è¯•æˆåŠŸï¼');
                } else {
                    log('âŒ å¤æ´»å¹¿å‘Šæµ‹è¯•å¤±è´¥');
                }
            });
        }

        // Canvasç‚¹å‡»æµ‹è¯•
        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');

        // ç»˜åˆ¶æµ‹è¯•å†…å®¹
        function drawTestContent() {
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å·¥ä½œå°
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(20, 133, 90, 80);
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            ctx.strokeRect(20, 133, 90, 80);
            
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('å·¥ä½œå°', 65, 180);
            
            // ç»˜åˆ¶é¡¾å®¢
            ctx.fillStyle = '#4169E1';
            ctx.fillRect(200 - 25, 300 - 40, 50, 80);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText('é¡¾å®¢', 200, 250);
        }

        // æ¨¡æ‹ŸGameManagerçš„handleTouch
        function handleCanvasClick(x, y) {
            log(`ğŸ–±ï¸ Canvasç‚¹å‡»: (${x}, ${y})`);
            
            // æ£€æŸ¥å·¥ä½œå°ç‚¹å‡» (20, 133, 90, 80)
            if (x >= 20 && x <= 110 && y >= 133 && y <= 213) {
                log('ğŸ­ å·¥ä½œå°è¢«ç‚¹å‡»ï¼');
                return true;
            }
            
            // æ£€æŸ¥é¡¾å®¢ç‚¹å‡» (175, 260, 50, 80)
            if (x >= 175 && x <= 225 && y >= 260 && y <= 340) {
                log('ğŸ‘¤ é¡¾å®¢è¢«ç‚¹å‡»ï¼');
                return true;
            }
            
            return false;
        }

        // ç»‘å®šCanvasäº‹ä»¶
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            handleCanvasClick(x, y);
        });

        // åˆå§‹åŒ–
        drawTestContent();
        log('ğŸ® H5ç‚¹å‡»äº‹ä»¶æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        log('ğŸ“‹ ç‚¹å‡»"æµ‹è¯•ç¯å¢ƒæ£€æµ‹"å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>
