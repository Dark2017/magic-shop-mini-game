<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é­”æ³•å•†åº—å¤§äº¨ - H5ç‰ˆ</title>
    <meta name="description" content="ç»è¥ä½ çš„é­”æ³•å•†åº—ï¼Œåˆ¶ä½œè¯æ°´ï¼Œå‡çº§è®¾å¤‡ï¼Œæˆä¸ºæœ€å¼ºå¤§çš„é­”æ³•å•†äººï¼">
    <meta name="keywords" content="é­”æ³•å•†åº—,ç»è¥æ¸¸æˆ,æ”¾ç½®æ¸¸æˆ,H5æ¸¸æˆ">
    
    <!-- PWAç›¸å…³ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2C1810">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMyQzE4MTAiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjRkZENzAwIj4KPHA+8J+PquKcqO+4jzwvcD4KPHN2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMyQzE4MTAiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjRkZENzAwIj4KPHA+8J+PquKcqO+4jzwvcD4KPHN2Zz4KPC9zdmc+">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1a0e0a 0%, #2C1810 50%, #1a0e0a 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none; /* é˜²æ­¢é¡µé¢æ»šåŠ¨ */
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 414px; /* iPhone 6 Pluså®½åº¦ */
            max-height: 896px; /* iPhone XRé«˜åº¦ */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        canvas {
            background: #000;
            border-radius: 0;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            width: 100%;
            height: 100%;
            object-fit: contain;
            touch-action: none;
        }
        
        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2C1810 0%, #FFD700 50%, #2C1810 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #FFD700;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        #loadingScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .loading-subtitle {
            font-size: 16px;
            margin-bottom: 30px;
            opacity: 0.8;
        }
        
        .loading-progress {
            width: 250px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        .loading-text {
            font-size: 14px;
            opacity: 0.7;
        }
        
        #errorScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: #ff6b6b;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
            text-align: center;
        }
        
        .error-title {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .error-message {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .retry-btn {
            background: #FFD700;
            color: #2C1810;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .retry-btn:hover {
            background: #FFA500;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 480px) {
            #gameContainer {
                max-width: 100vw;
                max-height: 100vh;
            }
            
            canvas {
                border-radius: 0;
            }
            
            .loading-title {
                font-size: 24px;
            }
            
            .loading-progress {
                width: 80%;
            }
        }
        
        /* æ¨ªå±é€‚é… */
        @media (orientation: landscape) and (max-height: 500px) {
            .loading-title {
                font-size: 20px;
                margin-bottom: 10px;
            }
            
            .loading-subtitle {
                font-size: 14px;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- åŠ è½½ç•Œé¢ -->
        <div id="loadingScreen">
            <div class="loading-title">ğŸª é­”æ³•å•†åº—å¤§äº¨</div>
            <div class="loading-subtitle">ç»è¥ä½ çš„é­”æ³•å•†åº—å¸å›½</div>
            <div class="loading-progress">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
            <div class="loading-text" id="loadingText">æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆ...</div>
        </div>
        
        <!-- é”™è¯¯ç•Œé¢ -->
        <div id="errorScreen">
            <div class="error-title">âš ï¸ æ¸¸æˆåŠ è½½å¤±è´¥</div>
            <div class="error-message" id="errorMessage">å‘ç”Ÿäº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•</div>
            <button class="retry-btn" onclick="location.reload()">é‡æ–°åŠ è½½</button>
        </div>
        
        <!-- æ¸¸æˆç”»å¸ƒ -->
        <canvas id="gameCanvas"></canvas>
    </div>
    
    <script>
        // H5ç¯å¢ƒé€‚é… - æ¨¡æ‹Ÿå¾®ä¿¡å°æ¸¸æˆAPI
        class H5GameAdapter {
            constructor() {
                this.setupCanvas();
                this.createWxAPI();
                this.setupGlobalErrorHandling();
                this.updateLoadingProgress(10, 'æ­£åœ¨åˆå§‹åŒ–ç¯å¢ƒ...');
            }
            
            setupCanvas() {
                const canvas = document.getElementById('gameCanvas');
                const container = document.getElementById('gameContainer');
                
                // åŠ¨æ€è®¾ç½®ç”»å¸ƒå°ºå¯¸
                const updateCanvasSize = () => {
                    const containerRect = container.getBoundingClientRect();
                    const aspectRatio = 9 / 16; // æ‰‹æœºå±å¹•æ¯”ä¾‹
                    
                    let displayWidth = containerRect.width;
                    let displayHeight = containerRect.height;
                    
                    // ä¿æŒå®½é«˜æ¯”
                    if (displayWidth / displayHeight > aspectRatio) {
                        displayWidth = displayHeight * aspectRatio;
                    } else {
                        displayHeight = displayWidth / aspectRatio;
                    }
                    
                    // é™åˆ¶æœ€å¤§å°ºå¯¸
                    displayWidth = Math.min(displayWidth, 414);
                    displayHeight = Math.min(displayHeight, 896);
                    
                    // é‡è¦ä¿®å¤ï¼šCanvaså†…éƒ¨åˆ†è¾¨ç‡ç›´æ¥ä½¿ç”¨æ˜¾ç¤ºå°ºå¯¸
                    // ä¸ä½¿ç”¨è®¾å¤‡åƒç´ æ¯”ç¼©æ”¾ï¼Œé¿å…æ¸²æŸ“åæ ‡é”™ä½
                    canvas.width = displayWidth;
                    canvas.height = displayHeight;
                    
                    // è®¾ç½®ç”»å¸ƒæ˜¾ç¤ºå°ºå¯¸
                    canvas.style.width = displayWidth + 'px';
                    canvas.style.height = displayHeight + 'px';
                    
                    // ç§»é™¤ctx.scale(dpr, dpr)ï¼Œé¿å…åæ ‡ç³»æ··ä¹±
                    // æ¸¸æˆé€»è¾‘ç›´æ¥ä½¿ç”¨Canvasçš„width/heightå³å¯
                    
                    console.log(`Canvasè®¾ç½®: æ˜¾ç¤ºå°ºå¯¸ ${displayWidth}x${displayHeight}, å†…éƒ¨åˆ†è¾¨ç‡ ${canvas.width}x${canvas.height}`);
                };
                
                updateCanvasSize();
                window.addEventListener('resize', updateCanvasSize);
                window.addEventListener('orientationchange', () => {
                    setTimeout(updateCanvasSize, 100);
                });
            }
            
            createWxAPI() {
                const canvas = document.getElementById('gameCanvas');
                const systemInfo = {
                    windowWidth: canvas.width,
                    windowHeight: canvas.height,
                    screenWidth: window.screen.width,
                    screenHeight: window.screen.height,
                    pixelRatio: window.devicePixelRatio || 1,
                    statusBarHeight: 0,
                    platform: this.detectPlatform(),
                    model: navigator.userAgent,
                    safeArea: {
                        top: 0,
                        bottom: canvas.height,
                        left: 0,
                        right: canvas.width
                    }
                };
                
                window.wx = {
                    getSystemInfoSync: () => systemInfo,
                    createCanvas: () => canvas,
                    createImage: () => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        return img;
                    },
                    onHide: (callback) => {
                        document.addEventListener('visibilitychange', () => {
                            if (document.hidden) callback();
                        });
                        window.addEventListener('blur', callback);
                        window.addEventListener('pagehide', callback);
                    },
                    onShow: (callback) => {
                        document.addEventListener('visibilitychange', () => {
                            if (!document.hidden) callback();
                        });
                        window.addEventListener('focus', callback);
                        window.addEventListener('pageshow', callback);
                    },
                    showActionSheet: (options) => {
                        const choice = prompt('è¯·é€‰æ‹©:\n' + options.itemList.map((item, i) => `${i + 1}: ${item}`).join('\n'));
                        const index = parseInt(choice) - 1;
                        if (!isNaN(index) && index >= 0 && index < options.itemList.length && options.success) {
                            options.success({ tapIndex: index });
                        } else if (options.fail) {
                            options.fail({ errMsg: 'showActionSheet:fail cancel' });
                        }
                    },
                    showModal: (options) => {
                        const result = confirm((options.title || '') + '\n\n' + (options.content || ''));
                        if (options.success) {
                            options.success({ confirm: result, cancel: !result });
                        }
                    },
                    showToast: (options) => {
                        console.log('Toast:', options.title);
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰çš„Toastæ˜¾ç¤ºé€»è¾‘
                        if (typeof options.title === 'string') {
                            this.showCustomToast(options.title, options.duration || 1500);
                        }
                    },
                    shareAppMessage: (options) => {
                        console.log('åˆ†äº«åŠŸèƒ½ (H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ):', options);
                        if (navigator.share) {
                            navigator.share({
                                title: options.title || 'é­”æ³•å•†åº—å¤§äº¨',
                                text: options.desc || 'å¿«æ¥å’Œæˆ‘ä¸€èµ·ç»è¥é­”æ³•å•†åº—å§ï¼',
                                url: window.location.href
                            }).catch(console.log);
                        } else {
                            this.showCustomToast('åˆ†äº«åŠŸèƒ½åœ¨H5ç¯å¢ƒä¸‹æš‚ä¸å¯ç”¨');
                        }
                    },
                    // æœ¬åœ°å­˜å‚¨API
                    getStorageSync: (key) => {
                        try {
                            const data = localStorage.getItem('magicShop_' + key);
                            return data ? JSON.parse(data) : null;
                        } catch (e) {
                            console.warn('è·å–å­˜å‚¨æ•°æ®å¤±è´¥:', e);
                            return null;
                        }
                    },
                    setStorageSync: (key, data) => {
                        try {
                            localStorage.setItem('magicShop_' + key, JSON.stringify(data));
                        } catch (e) {
                            console.warn('ä¿å­˜å­˜å‚¨æ•°æ®å¤±è´¥:', e);
                        }
                    },
                    removeStorageSync: (key) => {
                        try {
                            localStorage.removeItem('magicShop_' + key);
                        } catch (e) {
                            console.warn('åˆ é™¤å­˜å‚¨æ•°æ®å¤±è´¥:', e);
                        }
                    },
                    // äº‘å­˜å‚¨APIæ¨¡æ‹Ÿ
                    setUserCloudStorage: (options) => {
                        console.log('äº‘å­˜å‚¨ (H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ):', options.KVDataList);
                        if (options.success) {
                            setTimeout(options.success, 100);
                        }
                    },
                    // å¹¿å‘ŠAPIæ¨¡æ‹Ÿ
                    createRewardedVideoAd: (options) => {
                        const ad = {
                            load: () => {
                                console.log('åŠ è½½æ¿€åŠ±è§†é¢‘å¹¿å‘Š (H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ)');
                                return Promise.resolve();
                            },
                            show: () => {
                                console.log('æ˜¾ç¤ºæ¿€åŠ±è§†é¢‘å¹¿å‘Š (H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ)');
                                return Promise.resolve();
                            },
                            onLoad: (callback) => {
                                setTimeout(callback, 100);
                            },
                            onError: (callback) => {
                                // H5ç¯å¢ƒä¸‹é€šå¸¸ä¸ä¼šå‡ºé”™
                            },
                            onClose: (callback) => {
                                // æ¨¡æ‹Ÿè§‚çœ‹å®Œæˆ
                                setTimeout(() => {
                                    const watchedComplete = Math.random() > 0.2; // 80%æ¦‚ç‡è§‚çœ‹å®Œæˆ
                                    callback({ isEnded: watchedComplete });
                                }, 2000);
                            }
                        };
                        
                        // é‡è¦ï¼šæ·»åŠ H5ç¯å¢ƒæ ‡è¯†ï¼Œè®©AdManagerèƒ½æ­£ç¡®æ£€æµ‹ç¯å¢ƒ
                        ad.toString = () => 'function() { /* H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ */ }';
                        
                        return ad;
                    },
                    createBannerAd: (options) => ({
                        show: () => console.log('æ˜¾ç¤ºæ¨ªå¹…å¹¿å‘Š (H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ)'),
                        hide: () => console.log('éšè—æ¨ªå¹…å¹¿å‘Š (H5ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ)'),
                        onLoad: (callback) => setTimeout(callback, 100),
                        onError: (callback) => {}
                    })
                };
                
                this.updateLoadingProgress(30, 'æ­£åœ¨åŠ è½½æ¸¸æˆèµ„æº...');
            }
            
            detectPlatform() {
                const ua = navigator.userAgent.toLowerCase();
                if (ua.indexOf('iphone') > -1 || ua.indexOf('ipad') > -1) {
                    return 'ios';
                } else if (ua.indexOf('android') > -1) {
                    return 'android';
                } else {
                    return 'desktop';
                }
            }
            
            updateLoadingProgress(percent, text) {
                const loadingBar = document.getElementById('loadingBar');
                const loadingText = document.getElementById('loadingText');
                if (loadingBar) loadingBar.style.width = percent + '%';
                if (loadingText) loadingText.textContent = text;
            }
            
            showCustomToast(message, duration = 1500) {
                // åˆ›å»ºç®€å•çš„Toastæç¤º
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 80%;
                    text-align: center;
                `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, duration);
            }
            
            setupGlobalErrorHandling() {
                window.addEventListener('error', (e) => {
                    console.error('æ¸¸æˆè¿è¡Œé”™è¯¯:', e);
                    this.showError('æ¸¸æˆè¿è¡Œæ—¶å‘ç”Ÿé”™è¯¯: ' + e.message);
                });
                
                window.addEventListener('unhandledrejection', (e) => {
                    console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', e);
                    this.showError('æ¸¸æˆåŠ è½½å¤±è´¥: ' + e.reason);
                });
            }
            
            showError(message) {
                const errorScreen = document.getElementById('errorScreen');
                const errorMessage = document.getElementById('errorMessage');
                if (errorScreen && errorMessage) {
                    errorMessage.textContent = message;
                    errorScreen.style.display = 'flex';
                }
            }
            
            hideLoading() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }
            }
        }
        
        // åˆå§‹åŒ–H5é€‚é…å™¨
        const gameAdapter = new H5GameAdapter();
        
        // è®¾ç½®requestAnimationFrameå…¼å®¹æ€§
        window.requestAnimationFrame = window.requestAnimationFrame || 
                                       window.webkitRequestAnimationFrame || 
                                       window.mozRequestAnimationFrame ||
                                       function(callback) {
                                           return setTimeout(callback, 1000 / 60);
                                       };
    </script>
    
    <script type="module">
        try {
            gameAdapter.updateLoadingProgress(50, 'æ­£åœ¨åŠ è½½æ¸¸æˆæ¨¡å—...');
            
            // å¯¼å…¥æ¸¸æˆæ¨¡å—
            const [
                AdManager,
                DataManager,
                GameManager,
                UIManager,
                QuestManager
            ] = await Promise.all([
                import('./src/managers/AdManager.js'),
                import('./src/managers/DataManager.js'),
                import('./src/managers/GameManager.js'),
                import('./src/managers/UIManagerNew.js'),
                import('./src/managers/QuestManager.js')
            ]);
            
            gameAdapter.updateLoadingProgress(80, 'æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆ...');

            // H5ç‰ˆæ¸¸æˆä¸»ç±»
            class H5MagicShopGame {
                constructor() {
                    this.canvas = document.getElementById('gameCanvas');
                    this.ctx = this.canvas.getContext('2d');
                    
                    // åˆå§‹åŒ–ç®¡ç†å™¨
                    this.adManager = new AdManager.default();
                    this.dataManager = new DataManager.default();
                    this.questManager = new QuestManager.default();
                    this.gameManager = new GameManager.default(this.ctx, this.canvas);
                    this.uiManager = new UIManager.default(this.ctx, this.canvas);
                    
                    this.init();
                }
                
                init() {
                    console.log('H5é­”æ³•å•†åº—æ¸¸æˆåˆå§‹åŒ–å¼€å§‹');
                    
                    gameAdapter.updateLoadingProgress(90, 'æ­£åœ¨åŠ è½½æ¸¸æˆæ•°æ®...');
                    
                    // åŠ è½½æ¸¸æˆæ•°æ®
                    this.dataManager.loadData();
                    
                    // è®¾ç½®ç®¡ç†å™¨ä¹‹é—´çš„å…³è”
                    this.setupManagerReferences();
                    
                    // ç»‘å®šäº‹ä»¶
                    this.bindEvents();
                    
                    gameAdapter.updateLoadingProgress(100, 'æ¸¸æˆåŠ è½½å®Œæˆï¼');
                    
                    // å»¶è¿Ÿå¯åŠ¨æ¸¸æˆå¾ªç¯
                    setTimeout(() => {
                        gameAdapter.hideLoading();
                        this.gameLoop();
                        console.log('H5é­”æ³•å•†åº—æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
                    }, 500);
                }
                
                setupManagerReferences() {
                    // è®©QuestManagerèƒ½è®¿é—®å…¶ä»–ç®¡ç†å™¨
                    this.questManager.setManagers({
                        dataManager: this.dataManager,
                        gameManager: this.gameManager
                    });
                    
                    // è®©GameManagerèƒ½è®¿é—®å…¶ä»–ç®¡ç†å™¨
                    this.gameManager.setManagers({
                        adManager: this.adManager,
                        dataManager: this.dataManager,
                        uiManager: this.uiManager,
                        questManager: this.questManager
                    });
                    
                    // è®©UIManagerèƒ½è®¿é—®å…¶ä»–ç®¡ç†å™¨
                    this.uiManager.setManagers({
                        adManager: this.adManager,
                        dataManager: this.dataManager,
                        gameManager: this.gameManager,
                        questManager: this.questManager
                    });
                    
                    // è®©AdManagerèƒ½è®¿é—®å…¶ä»–ç®¡ç†å™¨
                    this.adManager.setManagers({
                        dataManager: this.dataManager,
                        gameManager: this.gameManager,
                        uiManager: this.uiManager
                    });
                    
                    // è®©DataManagerèƒ½è®¿é—®å…¶ä»–ç®¡ç†å™¨
                    this.dataManager.setManagers({
                        gameManager: this.gameManager
                    });
                }
                
                bindEvents() {
                    // è§¦æ‘¸å’Œç‚¹å‡»äº‹ä»¶
                    const handleTouch = (e) => {
                        e.preventDefault();
                        
                        let touch;
                        if (e.type === 'touchstart' || e.type === 'touchend') {
                            touch = e.touches[0] || e.changedTouches[0];
                        } else {
                            touch = e;
                        }
                        
                        if (!touch) return;
                        
                        const rect = this.canvas.getBoundingClientRect();
                        
                        // ç›´æ¥ä½¿ç”¨Canvasæ˜¾ç¤ºåŒºåŸŸçš„åæ ‡è½¬æ¢
                        // æ¸¸æˆé€»è¾‘ä½¿ç”¨çš„æ˜¯Canvasçš„æ˜¾ç¤ºå°ºå¯¸ï¼Œä¸æ˜¯å†…éƒ¨åˆ†è¾¨ç‡
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        console.log('Touch/Click event:', x, y);
                        
                        // è®°å½•è§¦æ‘¸å¼€å§‹ä½ç½®ï¼Œç”¨äºæ»‘åŠ¨åˆ¤æ–­
                        if (e.type === 'touchstart') {
                            this.touchStartY = y;
                            this.touchStartTime = Date.now();
                            this.uiManager.handleTouchStart && this.uiManager.handleTouchStart(x, y);
                        } else if (e.type === 'touchend' || e.type === 'click') {
                            // å…ˆè®©UIç®¡ç†å™¨å¤„ç†è§¦æ‘¸ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
                            const uiHandled = this.uiManager.handleTouch(x, y);
                            console.log('UI handled touch:', uiHandled);
                            
                            // å¦‚æœUIæ²¡æœ‰å¤„ç†è¿™ä¸ªè§¦æ‘¸ï¼Œå†è®©æ¸¸æˆç®¡ç†å™¨å¤„ç†
                            if (!uiHandled) {
                                console.log('Passing touch to game manager, canvas coords:', x, y);
                                // ä¼ é€’canvasåæ ‡ç»™GameManagerï¼Œä½¿ç”¨ç®€åŒ–çš„æ ¼å¼
                                const gameTouch = {
                                    x: x,
                                    y: y,
                                    clientX: x, // å…¼å®¹æ€§ï¼šåŒæ—¶æä¾›clientX/clientY
                                    clientY: y
                                };
                                this.gameManager.handleTouch(gameTouch);
                            }
                            
                            this.uiManager.handleTouchEnd && this.uiManager.handleTouchEnd(x, y);
                        }
                    };
                    
                    // è§¦æ‘¸ç§»åŠ¨äº‹ä»¶ - å¤„ç†æ»šåŠ¨
                    const handleTouchMove = (e) => {
                        e.preventDefault();
                        
                        if (this.touchStartY !== undefined) {
                            const touch = e.touches[0];
                            const rect = this.canvas.getBoundingClientRect();
                            const scaleY = this.canvas.height / rect.height;
                            const y = (touch.clientY - rect.top) * scaleY;
                            
                            const deltaY = y - this.touchStartY;
                            const deltaTime = Date.now() - this.touchStartTime;
                            
                            // å¦‚æœç§»åŠ¨è·ç¦»è¶³å¤Ÿå¤§ä¸”æ—¶é—´è¶³å¤ŸçŸ­ï¼Œè®¤ä¸ºæ˜¯æ»šåŠ¨æ‰‹åŠ¿
                            if (Math.abs(deltaY) > 10 && deltaTime < 500) {
                                const rect = this.canvas.getBoundingClientRect();
                                const scaleX = this.canvas.width / rect.width;
                                const x = (touch.clientX - rect.left) * scaleX;
                                
                                // ä¼ é€’æ»‘åŠ¨äº‹ä»¶ç»™UIç®¡ç†å™¨
                                const scrollHandled = this.uiManager.handleTouchMove && 
                                                     this.uiManager.handleTouchMove(x, y);
                                console.log('Touch move handled by UI:', scrollHandled);
                                
                                // æ›´æ–°èµ·å§‹ä½ç½®
                                this.touchStartY = y;
                            }
                        }
                    };
                    
                    // ç»‘å®šäº‹ä»¶
                    this.canvas.addEventListener('touchstart', handleTouch, { passive: false });
                    this.canvas.addEventListener('touchend', handleTouch, { passive: false });
                    this.canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
                    this.canvas.addEventListener('click', handleTouch);
                    
                    // é¼ æ ‡æ»šè½®äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                    this.canvas.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        const scrollHandled = this.uiManager.handleScroll && 
                                             this.uiManager.handleScroll(e.deltaY * 0.3);
                        console.log('Wheel scroll handled by UI:', scrollHandled);
                    }, { passive: false });
                    
                    // çª—å£å¤±ç„¦å’Œèšç„¦
                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden) {
                            this.dataManager.saveData();
                            this.gameManager.calculateOfflineProgress();
                        } else {
                            this.gameManager.showOfflineRewards();
                        }
                    });
                    
                    window.addEventListener('beforeunload', () => {
                        this.dataManager.saveData();
                    });
                }
                
                gameLoop() {
                    this.update();
                    this.render();
                    requestAnimationFrame(() => this.gameLoop());
                }
                
                update() {
                    this.gameManager.update();
                    this.uiManager.update();
                    this.questManager.update();
                }
                
                render() {
                    // æ¸…ç©ºç”»å¸ƒ
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // æ¸²æŸ“æ¸¸æˆ
                    this.gameManager.render();
                    
                    // æ¸²æŸ“UIå±‚
                    this.uiManager.render();
                    
                    // æœ€åæ¸²æŸ“çƒŸèŠ±ç²’å­ï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨æœ€é¡¶å±‚
                    this.gameManager.renderFireworkParticles && this.gameManager.renderFireworkParticles();
                }
            }

            // å¯åŠ¨H5æ¸¸æˆ
            window.magicShopGame = new H5MagicShopGame();
            
        } catch (error) {
            console.error('æ¸¸æˆåŠ è½½å¤±è´¥:', error);
            gameAdapter.showError('æ¸¸æˆåŠ è½½å¤±è´¥: ' + error.message);
        }
    </script>
</body>
</html>
